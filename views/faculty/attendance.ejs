<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/dashboard.css" rel="stylesheet">
</head>
<body class="dashboard-body">
    
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom fixed-top">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light d-lg-none me-2" type="button" id="sidebarToggle">
                    <i class="bi bi-list"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="/faculty/dashboard">
                    <i class="bi bi-mortarboard me-2 text-white" style="font-size: 1.5rem;"></i>
                    <span class="fw-bold">Lab Exam Portal</span>
                </a>
            </div>
            
            <!-- User Menu -->
            <div class="dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center text-white" 
                   href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                    <img src="<%= user.profileImage || '/images/default-avatar.png' %>" 
                         alt="Avatar" width="32" height="32" class="rounded-circle me-2" id="navbarAvatar">
                    <span class="d-none d-sm-inline">
                        <%= user.firstName %> <%= user.lastName %>
                    </span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <div class="dropdown-header">
                            <strong><%= user.firstName %> <%= user.lastName %></strong><br>
                            <small class="text-muted"><%= user.email %></small><br>
                            <span class="badge bg-success">Faculty</span>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/faculty/settings">
                        <i class="bi bi-gear me-2"></i>Settings
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="confirmLogout()">
                        <i class="bi bi-box-arrow-right me-2"></i>Logout
                    </a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h5 class="text-white mb-0">Faculty Portal</h5>
            <small class="text-white-50">Teaching Dashboard</small>
        </div>
        
        <ul class="sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="/faculty/dashboard">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/faculty/attendance">
                    <i class="bi bi-clipboard-check"></i>
                    <span>Attendance</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/faculty/grading">
                    <i class="bi bi-journal-text"></i>
                    <span>Grading</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/faculty/results">
                    <i class="bi bi-bar-chart-line"></i>
                    <span>Results & Reports</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/faculty/students">
                    <i class="bi bi-people"></i>
                    <span>Student Management</span>
                </a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="content-wrapper">
            
            <!-- Page Header -->
            <div class="page-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h1 class="page-title">
                            <i class="bi bi-clipboard-check me-2"></i>
                            Attendance Management
                        </h1>
                        <p class="page-subtitle">Mark student attendance - Present or Absent for today's class</p>
                    </div>
                    <div class="col-auto">
                        <div class="badge bg-info fs-6">
                            <i class="bi bi-calendar-date me-1"></i>
                            <%= moment().format('MMM DD, YYYY') %>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters and Controls -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card card-custom">
                        <div class="card-body py-3">
                            <form method="GET" id="attendanceForm">
                                <div class="row align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Select Class</label>
                                        <select class="form-select" name="classId" onchange="this.form.submit()">
                                            <option value="">Choose a class...</option>
                                            <% classes.forEach(cls => { %>
                                                <option value="<%= cls._id %>" <%= selectedClass && selectedClass._id.equals(cls._id) ? 'selected' : '' %>>
                                                    <%= cls.className %> (<%= cls.classCode %>)
                                                </option>
                                            <% }); %>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Today's Date</label>
                                        <input type="text" class="form-control" 
                                               value="<%= moment().format('MMM DD, YYYY') %>" 
                                               readonly style="background: #f8f9fa;">
                                        <input type="hidden" name="date" value="<%= moment().format('YYYY-MM-DD') %>">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Filter</label>
                                        <select class="form-select" name="status" onchange="this.form.submit()">
                                            <option value="all" <%= selectedStatus === 'all' ? 'selected' : '' %>>All</option>
                                            <option value="Present" <%= selectedStatus === 'Present' ? 'selected' : '' %>>Present</option>
                                            <option value="Absent" <%= selectedStatus === 'Absent' ? 'selected' : '' %>>Absent</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex gap-2">
                                            <% if (selectedClass) { %>
                                                <button type="button" class="btn btn-success" onclick="markAllPresent()">
                                                    <i class="bi bi-check-all me-1"></i>
                                                    All Present
                                                </button>
                                                <button type="button" class="btn btn-primary" onclick="saveAllAttendance()">
                                                    <i class="bi bi-save me-1"></i>
                                                    Save All
                                                </button>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Content -->
            <% if (selectedClass) { %>
                
                <!-- Attendance Summary -->
                <% if (selectedClass.studentsWithAttendance) { %>
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="attendance-summary">
                                <% 
                                const presentCount = selectedClass.studentsWithAttendance.filter(s => s.attendance && s.attendance.status === 'Present').length;
                                const absentCount = selectedClass.studentsWithAttendance.filter(s => s.attendance && s.attendance.status === 'Absent').length;
                                const totalStudents = selectedClass.studentsWithAttendance.length;
                                const attendanceRate = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
                                %>
                                
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="stat-card bg-success bg-opacity-10 border border-success rounded p-3">
                                            <i class="bi bi-check-circle text-success fs-2"></i>
                                            <h3 class="text-success"><%= presentCount %></h3>
                                            <p class="text-muted mb-0">Present</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card bg-danger bg-opacity-10 border border-danger rounded p-3">
                                            <i class="bi bi-x-circle text-danger fs-2"></i>
                                            <h3 class="text-danger"><%= absentCount %></h3>
                                            <p class="text-muted mb-0">Absent</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card bg-primary bg-opacity-10 border border-primary rounded p-3">
                                            <i class="bi bi-people text-primary fs-2"></i>
                                            <h3 class="text-primary"><%= totalStudents %></h3>
                                            <p class="text-muted mb-0">Total Students</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stat-card bg-info bg-opacity-10 border border-info rounded p-3">
                                            <i class="bi bi-percent text-info fs-2"></i>
                                            <h3 class="text-info"><%= attendanceRate %>%</h3>
                                            <p class="text-muted mb-0">Attendance Rate</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>
                
                <!-- Class Information -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card card-custom">
                            <div class="card-header bg-success bg-opacity-10">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="mb-0 text-success">
                                            <i class="bi bi-book me-2"></i>
                                            <%= selectedClass.className %>
                                        </h5>
                                        <small class="text-muted">
                                            <%= selectedClass.subject %> • <%= selectedClass.classCode %> • Semester <%= selectedClass.semester %> • Year <%= selectedClass.year %>
                                        </small>
                                    </div>
                                    <div class="col-md-4 text-md-end">
                                        <span class="badge bg-primary fs-6">
                                            <i class="bi bi-people me-1"></i>
                                            <%= selectedClass.studentIds.length %> Students
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Student Attendance List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card card-custom">
                            <div class="card-header">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="mb-0">
                                            <i class="bi bi-list-check me-2"></i>
                                            Student Attendance - <%= moment().format('MMM DD, YYYY') %>
                                        </h5>
                                    </div>
                                    <div class="col-auto">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="quickModeToggle">
                                            <label class="form-check-label" for="quickModeToggle">
                                                Auto-Save Mode
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="40">#</th>
                                                <th>Student Details</th>
                                                <th width="150">Status</th>
                                                <th width="200">Remarks</th>
                                                <th width="150">Quick Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendanceTableBody">
                                            <% selectedClass.studentsWithAttendance.forEach((student, index) => { %>
                                                <tr class="attendance-row" data-student-id="<%= student._id %>">
                                                    <td><%= index + 1 %></td>
                                                    <td>
                                                        <div class="student-info d-flex align-items-center">
                                                            <img src="<%= student.profileImage || '/images/default-avatar.png' %>" 
                                                                 alt="Avatar" width="40" height="40" class="rounded-circle me-3">
                                                            <div>
                                                                <h6 class="mb-1"><%= student.firstName %> <%= student.lastName %></h6>
                                                                <small class="text-muted"><%= student.email %></small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm attendance-status" 
                                                                data-student-id="<%= student._id %>"
                                                                onchange="updateAttendanceStatus(this)">
                                                            <option value="">Not Marked</option>
                                                            <option value="Present" <%= student.attendance && student.attendance.status === 'Present' ? 'selected' : '' %>>
                                                                ✅ Present
                                                            </option>
                                                            <option value="Absent" <%= student.attendance && student.attendance.status === 'Absent' ? 'selected' : '' %>>
                                                                ❌ Absent
                                                            </option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm attendance-remarks" 
                                                               data-student-id="<%= student._id %>"
                                                               placeholder="Optional remarks..."
                                                               value="<%= student.attendance ? student.attendance.remarks || '' : '' %>">
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <button class="btn btn-outline-success" 
                                                                    onclick="quickMark('<%= student._id %>', 'Present')"
                                                                    title="Mark Present">
                                                                <i class="bi bi-check"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger" 
                                                                    onclick="quickMark('<%= student._id %>', 'Absent')"
                                                                    title="Mark Absent">
                                                                <i class="bi bi-x"></i>
                                                            </button>
                                                            <button class="btn btn-outline-primary" 
                                                                    onclick="saveIndividualAttendance('<%= student._id %>')"
                                                                    title="Save">
                                                                <i class="bi bi-save"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Use Auto-Save mode for automatic saving. Quick actions save immediately.
                                        </small>
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-success" onclick="saveAllAttendance()">
                                            <i class="bi bi-check-all me-2"></i>
                                            Save All Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            <% } else { %>
                
                <!-- No Class Selected -->
                <div class="row">
                    <div class="col-12">
                        <div class="card card-custom">
                            <div class="card-body text-center py-5">
                                <i class="bi bi-clipboard-check text-muted" style="font-size: 4rem;"></i>
                                <h4 class="mt-4 text-muted">Select a Class</h4>
                                <p class="text-muted mb-4">
                                    Choose a class from the dropdown above to start marking attendance for today.
                                </p>
                                <% if (classes.length === 0) { %>
                                    <div class="alert alert-warning">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        You don't have any assigned classes yet. Contact the administrator to assign classes.
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
                
            <% } %>
            
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/dashboard.js"></script>
    
    <script>
        // Logout confirmation
        function confirmLogout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '/auth/logout';
            }
        }
        
        // Sidebar toggle
        document.getElementById('sidebarToggle')?.addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('show');
        });
        
        let quickMode = false;
        
        // Toggle quick mode
        document.getElementById('quickModeToggle')?.addEventListener('change', function() {
            quickMode = this.checked;
            if (quickMode) {
                showToast('Auto-save mode enabled - changes will be saved automatically', 'success');
            } else {
                showToast('Auto-save mode disabled', 'info');
            }
        });
        
        // Update attendance status (simplified for Present/Absent only)
        function updateAttendanceStatus(selectElement) {
            const studentId = selectElement.dataset.studentId;
            const status = selectElement.value;
            const row = selectElement.closest('tr');
            
            // Update row styling based on status
            row.classList.remove('table-success', 'table-danger');
            if (status === 'Present') {
                row.classList.add('table-success');
            } else if (status === 'Absent') {
                row.classList.add('table-danger');
            }
            
            // Auto-save in quick mode
            if (quickMode && status) {
                setTimeout(() => saveIndividualAttendance(studentId), 500);
            }
        }
        
        // Quick mark function
        function quickMark(studentId, status) {
            const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
            const statusSelect = row.querySelector('.attendance-status');
            
            statusSelect.value = status;
            updateAttendanceStatus(statusSelect);
            
            // Always save immediately for quick actions
            saveIndividualAttendance(studentId);
        }
        
        // Mark all present
        function markAllPresent() {
            const allStatusSelects = document.querySelectorAll('.attendance-status');
            let markedCount = 0;
            
            allStatusSelects.forEach(select => {
                if (select.value !== 'Present') {
                    select.value = 'Present';
                    updateAttendanceStatus(select);
                    markedCount++;
                }
            });
            
            if (markedCount > 0) {
                showToast(`Marked ${markedCount} students as present`, 'success');
            } else {
                showToast('All students already marked as present', 'info');
            }
            
            if (quickMode) {
                setTimeout(() => saveAllAttendance(), 1000);
            }
        }
        
        // Save individual attendance
        async function saveIndividualAttendance(studentId) {
            const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
            if (!row) return;
            
            const status = row.querySelector('.attendance-status').value;
            const remarks = row.querySelector('.attendance-remarks').value;
            
            if (!status) {
                showToast('Please select attendance status', 'warning');
                return;
            }
            
            const data = {
                studentId: studentId,
                classId: '<%= selectedClass ? selectedClass._id : "" %>',
                status: status,
                remarks: remarks || ''
            };
            
            try {
                const response = await fetch('/api/faculty/attendance/mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add visual feedback
                    const saveBtn = row.querySelector('.btn-outline-primary');
                    if (saveBtn) {
                        saveBtn.classList.remove('btn-outline-primary');
                        saveBtn.classList.add('btn-success');
                        setTimeout(() => {
                            saveBtn.classList.remove('btn-success');
                            saveBtn.classList.add('btn-outline-primary');
                        }, 2000);
                    }
                    console.log('Attendance saved for student:', studentId);
                } else {
                    showToast(result.message || 'Failed to save attendance', 'danger');
                }
            } catch (error) {
                showToast('Error saving attendance', 'danger');
                console.error('Attendance save error:', error);
            }
        }
        
        // Save all attendance
        async function saveAllAttendance() {
            const attendanceData = [];
            const rows = document.querySelectorAll('.attendance-row');
            
            rows.forEach(row => {
                const studentId = row.dataset.studentId;
                const status = row.querySelector('.attendance-status').value;
                const remarks = row.querySelector('.attendance-remarks').value;
                
                if (status) {
                    attendanceData.push({
                        studentId: studentId,
                        status: status,
                        remarks: remarks || ''
                    });
                }
            });
            
            if (attendanceData.length === 0) {
                showToast('No attendance records to save', 'warning');
                return;
            }
            
            const data = {
                classId: '<%= selectedClass ? selectedClass._id : "" %>',
                attendanceRecords: attendanceData
            };
            
            try {
                showToast('Saving attendance records...', 'info');
                
                const response = await fetch('/api/faculty/attendance/bulk-mark', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(`Successfully saved ${result.saved} attendance records`, 'success');
                    // Refresh page to show updated statistics
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showToast(result.message || 'Failed to save attendance', 'danger');
                }
            } catch (error) {
                showToast('Error saving attendance records', 'danger');
                console.error('Bulk attendance save error:', error);
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = `
                top: 80px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            `;
            
            const iconMap = {
                success: 'bi-check-circle',
                danger: 'bi-exclamation-triangle',
                warning: 'bi-exclamation-triangle',
                info: 'bi-info-circle'
            };
            
            toast.innerHTML = `
                <i class="bi ${iconMap[type] || 'bi-info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(toast);
                bsAlert.close();
            }, type === 'success' ? 4000 : 3000);
        }
        
        // Initialize existing attendance styling
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.attendance-status').forEach(select => {
                if (select.value) {
                    updateAttendanceStatus(select);
                }
            });
        });
    </script>
    
</body>
</html>
